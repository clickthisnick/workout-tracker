<!doctype html>
<html ng-app="WorkoutApp">

<head>
    <!-- Needed for mobile to function (somewhat) -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" type="text/css" href="assets/ceruleanBootswatch.min.css">
    <style>
        body {
            background-color: black;
            color: white;
        }

        input,
        button {
            background-color: rgb(58, 25, 25);
            background: rgb(58, 25, 25);
            color: white;
        }
    </style>

    <script>
        // Global we can reset at any point
        let timerInterval = ""; 

        const loadWorkoutOptions = async () => {
            const response = await fetch('https://www.clickthisnick.com/workout-tracker/src/workouts/active.json');
            const workouts = await response.json(); //extract JSON from the http response
            const workoutNames = workouts['workouts']
            var select = document.getElementById("selectWorkout");

            for(var i = 0; i < workoutNames.length; i++) {
                var opt = workoutNames[i];
                var el = document.createElement("option");
                el.textContent = opt;
                el.value = opt;
                select.appendChild(el);
            }
        }

        // If I want this to work without internet once its loaded, I need to cache this in the browser
        // Or check if it will be cached - maybe browsers already do that
        // Check duration if browser already cache - ie will this last up to an hour
        const getData = async (routine, params) => {
            const response = await fetch(`https://www.clickthisnick.com/workout-tracker/src/workouts/${routine}`);
            const resp = await response.json(); //extract JSON from the http response

            const url = new URL(location.href);
            url.searchParams.set('name', resp['name']);
            url.searchParams.set('exercises', JSON.stringify(resp['exercises']));
            url.searchParams.set('previousWorkout', JSON.stringify(resp['workouts'][resp['workouts'].length - 1]));
            url.searchParams.set('startMilliseconds', getTimeMillisecondsDate());
            // We start off showing the first exercise
            url.searchParams.set('currentExerciseId', 0);
            reloadPage(url)
        }

        function decodeQueryParam(p) {
            return decodeURIComponent(p.replace(/\+/g, " "));
        }

        function getTimeMillisecondsDate() {
            const date = new Date();
            return date.getTime();
        }

        function reloadPage(url) {
            location.href = url
        }

        function startWorkout(workoutName, params) {
            // Hide the dropdown menu
            document.getElementById("selectWorkout").style.visibility = "hidden";

            // Redirects to url with routineSelected
            // That way if browser refreshes we don't lose our state
            const url = new URL(location.href);
            if (!url.searchParams.get("name")) {
                // Load the data into the url bar and refresh
                getData(workoutName, params)
                return
            }

            renderPage()
        }

        function saveExerciseData(url, reloadPage = false) {
            const currentExerciseId = parseInt(url.searchParams.get("currentExerciseId"))
            const exerciseData = getExerciseData(url.searchParams.get("exerciseData"))
            const reps = document.getElementById('reps').value
            const weight = document.getElementById('weight').value

            exerciseData[currentExerciseId][0] = reps.split(",")
            exerciseData[currentExerciseId][1] = weight.split(",")

            url.searchParams.set("exerciseData", JSON.stringify(exerciseData));

            if (reloadPage) {
               reloadPage(url)
            }
        }

        function nextExercise() {
            const url = new URL(location.href);
            const currentExercideId = parseInt(url.searchParams.get("currentExerciseId"))
            const exerciseData = getExerciseData(params.exerciseData);

            // Dont allow next if we are at the last exercise
            if (currentExercideId == exerciseData.length -1 ) {
                return
            }

            saveExerciseData(url);
            url.searchParams.set("currentExerciseId", currentExercideId + 1);
            reloadPage(url)
        }

        function prevExercise() {
            const url = new URL(location.href);
            const currentExercideId = parseInt(url.searchParams.get("currentExerciseId"))

            // Dont allow negative indexs
            if (currentExercideId == 0) {
                return
            }

            saveExerciseData(url);
            url.searchParams.set("currentExerciseId", currentExercideId - 1);

            reloadPage(url)
        }

        function getExerciseData(exerciseDataQueryParam) {
            return JSON.parse(decodeQueryParam(exerciseDataQueryParam));
        }

        function loadJSONQueryParamter(data) {
            return JSON.parse(decodeQueryParam(data));
        }

        function calulateDaysAgo(endMilliseconds) {
            const ms = getTimeMillisecondsDate();
            const msSinceWorkout = ms - endMilliseconds;

            return daysSinceLastDoneWorkout = Math.floor(msSinceWorkout / (1000 * 60 * 60) / 24);
        }

        function getQueryParameters() {
            return new Proxy(new URLSearchParams(window.location.search), {
                get: (searchParams, prop) => searchParams.get(prop),
            });
        }

        function getNewExerciseData(exercises, url, key) {
            if (url.searchParams.get(key)) {
                return getExerciseData(url.searchParams.get(key))
            }

            const value = JSON.stringify(Array(exercises.length).fill([]))
            url.searchParams.set(key, value)
            return getExerciseData(value)
        }

        function renderPage() {
            const url = new URL(location.href);

            const name = url.searchParams.get('name')
            const exercises = loadJSONQueryParamter(url.searchParams.get('exercises'));
            const previousWorkout = loadJSONQueryParamter(url.searchParams.get('previousWorkout'));
            const startMilliseconds = url.searchParams.get('startMilliseconds')
            const currentExerciseId = parseInt(url.searchParams.get('currentExerciseId'))
            const currentExercsie = exercises[currentExerciseId]
 
            const currentReps = getNewExerciseData(exercises, url, "currentReps")
            const currentWeights = getNewExerciseData(exercises, url, "currentWeights")

            document.getElementById('workoutName').innerHTML = name
            document.getElementById('workoutLastCompleted').innerHTML = `Last Completed: ${calulateDaysAgo(previousWorkout['endMilliseconds'])} days ago.`
            document.getElementById('workout').style.visibility = 'visible'

            const previousWorkoutExerciseReps = previousWorkout['reps'][currentExerciseId];
            const previousWorkoutExerciseWeights = previousWorkout['weights'][currentExerciseId];

            document.getElementById('currentExercise').innerHTML = currentExercsie
            document.getElementById('previousWorkoutExerciseReps').innerHTML = `Reps: ${previousWorkoutExerciseReps}`
            document.getElementById('previousWorkoutExerciseWeights').innerHTML = `Weight: ${previousWorkoutExerciseWeights}`

            document.getElementById('reps').value = currentReps[currentExerciseId]
            document.getElementById('weights').value = currentWeights[currentExerciseId]
        }

        function selectWorkout() {
            selectedWorkoutRoutineName = document.getElementById("selectWorkout").value;
            startWorkout(selectedWorkoutRoutineName, null)
        }

        const params = getQueryParameters()

        // Check if we already have the data in the url bar
        const name = params.name;

        if (name) {
            // This timeout ensures this gets executed _after_ the html renders
            setTimeout(function() {
                startWorkout(name, params)
            }, 0); // 0 second in milliseconds
        } else {
            // Load the drop down so user can select the workout name
            loadWorkoutOptions()
        }

        function saveWorkout() {
            const url = new URL(location.href);
            const exerciseDataParam = url.searchParams.get("exerciseData")
            const exerciseData = getExerciseData(exerciseDataParam);

            const data = {
                "startMilliseconds": url.searchParams.get("startMilliseconds"),
                "endMilliseconds":  getTimeMillisecondsDate(),
                "reps": exerciseData.reps,
                "weights": exerciseData.weights,
            }

            const a = document.createElement('a');
            a.target = '_blank';
            a.href = `mailto:remove_this@email.com?subject=${encodeURIComponent(url.searchParams.get("routineName"))}&body=${JSON.stringify(data)}`;
            a.click();
        }

        function resetTimer() {
            const timeSpan = document.getElementById('timer');
            const mins = 1.5;
            const now = new Date().getTime();
            const deadline = mins * 60 * 1000 + now;

            try {
                clearInterval(timerInterval);
            } catch {
                pass;
            }

            timerInterval = setInterval(() => {
            const currentTime = new Date().getTime();
            const distance = deadline - currentTime;
            let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // The minutes are 1 off once negative
            if (minutes < 0) {
                minutes = minutes + 1;
            }

            if (minutes == 0 && seconds == 0) {
                timerStarted = false;
            }

            if (minutes == 0 && seconds <= 0 && seconds > -2) {
                playSound('sounds/a-tone.mp3');
            }

            let timeToShow = minutes + 'm ' + seconds + 's';

            if (minutes == 0) {
                timeToShow = seconds + 's';
            }

            timeSpan.innerHTML = timeToShow;
            }, 500);
        };

    </script>
</head>

<select id="selectWorkout" onchange="selectWorkout()">
    <option>Choose a workout</option>
</select>

<div id="workout" style="visibility:hidden">
    <div id="header">
        <span id="workoutName"></span><br>
        <span id="workoutLastCompleted"></span><br>
        <span id="currentExercise"></span>
        <br>
        <button onclick="prevExercise()">Prev</button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button onclick="nextExercise()">Next</button>
        <br><br>Previous:<br>
        <span id="previousWorkoutExerciseReps"></span><br>
        <span id="previousWorkoutExerciseWeights"></span><br>
        Current:
        <span id="currentWorkoutExerciseReps"></span><br>
        <span id="currentWorkoutExerciseWeights"></span><br>
        <label for="reps">Reps:</label>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="reps" name="reps"><br><br>
        <label for="weights">Weight:</label>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" id="weights" name="weights"><br><br>
        <button onclick="saveWorkout()">Save Workout</button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button onclick="resetTimer()">Timer</button><span id="timer"></span>     
    </div>
</div>
